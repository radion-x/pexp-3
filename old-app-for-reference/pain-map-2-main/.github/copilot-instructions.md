# Pain Assessment Tool - Copilot Instructions

## Architecture Overview

This is a **single-page pain assessment application** with a React/TypeScript frontend and Node.js/Express backend focused exclusively on pain mapping and red flag symptom evaluation.

**Frontend:** `/client/` - React 18 + TypeScript + Vite + Tailwind CSS  
**Backend:** `/server/` - Node.js + Express + MongoDB + Anthropic Claude API  
**File Structure:** Session-based uploads in `/server/public/uploads/assessment_files/{session-id}/`

## Critical Development Patterns

### Form State Management
- **Context Pattern:** All form data flows through `FormContext.tsx` using a centralized state object
- **Session IDs:** Each form session gets a unique ID (`session-{timestamp}-{random}`) for file organization
- **Single-Page Form:** No step navigation - all content on one scrollable page
- **Data Structure:** Simplified `formData.ts` with only: email, fullName, painAreas, redFlags, treatmentGoals, pain map images

### File Upload Workflow
1. **Pain Map Images:** Generated client-side from canvas, uploaded to `/uploads/assessment_files/{sessionId}/`
2. **No Document Uploads:** Removed imaging/medical document upload functionality
3. **Database Reference:** Only pain map image paths stored in MongoDB, not file content
4. **Public Access:** Files served statically via `SERVER_BASE_URL/uploads/assessment_files/...`

### Environment Configuration
- **Port Synchronization:** `SERVER_PORT` in `.env` MUST match `vite.config.ts` proxy target port
- **API Keys:** Claude API key required for AI summary generation
- **Email:** Mailgun SMTP for automated notifications to patients/doctors
- **Database:** MongoDB connection via `MONGODB_URI`

## Key Integration Points

### AI Summary Generation
```javascript
// Located in app.js, uses prompt-builder.js
const comprehensivePrompt = generateComprehensivePrompt(formData);
const claudeResponse = await anthropic.messages.create({
  model: "claude-3-sonnet-20240229",
  max_tokens: 4000,
  messages: [{ role: "user", content: comprehensivePrompt }]
});
```

### Frontend-Backend Data Flow
- **API Base:** All requests proxy through `/api` (configured in vite.config.ts)
- **Form Submission:** Submission to `/api/assessment/submit` triggers AI processing and email notifications
- **Pain Map Upload:** Images uploaded to `/api/upload/pain-map?formSessionId={id}` as PNG files

### Database Schema Critical Fields
```javascript
// Assessment.js model - SIMPLIFIED SCHEMA
{
  sessionId: String,              // Links to file upload directory
  email: String,                  // Patient email (required)
  fullName: String,               // Patient name (required)
  
  painAreas: [{                   // Pain mapping data
    region: String,               // Body region name
    intensity: Number,            // 1-10 scale
    coordinates: Object,          // {x, y} click position
    notes: String                 // Optional pain description
  }],
  
  redFlags: {                     // Red flag symptom questions
    bowelBladderDysfunction: Boolean,
    progressiveWeakness: Boolean,
    saddleAnesthesia: Boolean,
    unexplainedWeightLoss: Boolean,
    feverChills: Boolean,
    nightPain: Boolean,
    cancerHistory: Boolean,
    recentTrauma: Boolean,
    notes: String
  },
  
  treatmentGoals: String,         // Patient's treatment objectives
  painMapImageFront: String,      // File path to front body diagram
  painMapImageBack: String,       // File path to back body diagram
  
  aiSummary: String,              // Generated by Claude API
  systemRecommendation: String,   // AI urgency/triage recommendation
  createdAt: Date,
  updatedAt: Date
}
```

## Development Commands

```bash
# Development (requires 2 terminals)
cd server && npm start           # Backend on port from .env
cd client && npm run dev         # Frontend on port 5173

# Production Build (Automated via Coolify)
# DO NOT build locally or commit dist/ folder
# Coolify Dockerfile handles frontend build automatically via multi-stage build

# File Permissions
# Ensure server/public/uploads/ is writable by Node.js process
```

## Deployment Workflow (Coolify)

### Correct Workflow:
1. **Make changes** to source code in `client/src/` or `server/`
2. **Commit and push** ONLY source code (NOT dist folder):
   ```bash
   git add client/src/ server/
   git commit -m "Your changes"
   git push origin main
   ```
3. **Redeploy in Coolify** - Dockerfile automatically:
   - Builds frontend via multi-stage build
   - Copies built files to `server/public/dist`
   - Starts the Node.js server

### DO NOT:
- ❌ Run `npm run build` locally (unless testing)
- ❌ Run `build-frontend.sh` script
- ❌ Commit or push the `client/dist/` folder
- ❌ Manually copy files to `server/public/dist`

### Key Files:
- `server/Dockerfile` - Multi-stage build that compiles frontend automatically
- `.gitignore` - Excludes `client/dist/` from version control

## Application Flow & User Experience

### Single-Page Form Structure
The entire assessment is on ONE page with the following sections in order:

1. **Header Section**
   - App title and description
   - Theme toggle (dark/light mode)

2. **Basic Information** (Required)
   - Email input (validated format)
   - Full name input
   - Both must be filled before proceeding

3. **Pain Mapping Section** (Core Feature)
   - Interactive body diagrams (toggle front/back view)
   - **523 Anatomical Hotspots:** Comprehensive coverage of entire body (134 front, 389 back)
   - Click-to-select pain regions with automatic anatomical region detection
   - Each pain point displays:
     - **Anatomical region name** (e.g., "Left Upper Trapezius", "Lumbar Spine L3-L4")
     - Intensity slider (1-10 scale)
     - Pain quality selectors (musculoskeletal, neuropathic, visceral, other)
     - Radiation notes textarea
     - Remove button
   - **Hotspot Detection:** Uses Euclidean distance to find closest anatomical region
   - **Anatomical Correction:** Front view swaps left/right labels for medical accuracy
   - Generates PNG images of marked diagrams

4. **Red Flags Section** (Required)
   - 8 yes/no checkboxes for critical symptoms:
     - Bowel/bladder dysfunction
     - Progressive weakness
     - Saddle anesthesia
     - Unexplained weight loss
     - Fever/chills
     - Night pain
     - Cancer history
     - Recent trauma
   - Optional notes field for additional context

5. **Treatment Goals** (Optional)
   - Freeform textarea for patient to describe objectives
   - Influences AI summary and recommendations

6. **Submit Section**
   - Submit button (enabled when required fields complete)
   - Shows AI summary after submission
   - Email confirmation message

### Validation Logic
- **Minimum Requirements:**
  - Valid email address
  - Full name (non-empty)
  - At least 1 pain point marked on body diagram
  - At least 1 red flag response (can be "no" to all, but must interact)
- **Progressive Disclosure:** Sections unlock as user progresses
- **Real-time Feedback:** Validation messages appear inline

## AI Summary Generation Details

### Prompt Structure (prompt-builder.js)
The AI prompt focuses exclusively on:
1. **Pain Pattern Analysis**
   - Distribution of pain across body regions
   - Intensity patterns and correlations
   - Pain quality descriptions from patient notes

2. **Red Flag Assessment**
   - Evaluation of urgent/emergent symptoms
   - Risk stratification (low/moderate/high urgency)
   - Clinical significance of positive findings

3. **Treatment Goal Alignment**
   - Patient's stated objectives
   - Realistic expectations based on presentation
   - Recommended next steps

### AI Output Format
```javascript
{
  aiSummary: "Comprehensive clinical narrative...",
  systemRecommendation: "LOW_URGENCY" | "MODERATE_URGENCY" | "HIGH_URGENCY"
}
```

## Email Notification Details

### Email Recipients
- **To:** Patient email (entered in form)
- **BCC:** Both doctor email and admin email (from .env)

### Email Content Sections
1. Patient name and submission timestamp
2. Pain areas table (region, intensity, notes)
3. Red flags section (only positive findings highlighted)
4. Treatment goals
5. Embedded pain map images (front and back)
6. AI-generated summary and recommendations
7. Footer with next steps/contact info

## Doctor Dashboard Integration

### Dashboard Features (Keep Existing)
- Password-protected access (`DASHBOARD_PASSWORD` in .env)
- List all assessments (newest first)
- View individual assessment details
- Display pain map images
- Show AI summary and recommendations

### Dashboard Updates Needed
- Remove filters/columns for deleted fields (surgeries, imaging, demographics)
- Simplify assessment card display
- Add red flag urgency badges (color-coded by systemRecommendation)
- Emphasize treatment goals in list view

## Common Issues & Solutions

- **Port Mismatch:** If API calls fail, verify `SERVER_PORT` matches vite proxy
- **Pain Map Not Saving:** Check canvas-to-blob conversion and session directory permissions
- **Email Failures:** Verify Mailgun credentials and sender/recipient addresses
- **AI Summary Errors:** Check Claude API key and prompt length limits (simplified prompt should stay under limits)
- **Theme Issues:** Dark/light mode handled via Tailwind classes with `dark:` prefixes
- **Validation Not Triggering:** Ensure all required fields checked before submit enabled
- **Hotspot Detection:** All 523 hotspots validated - if "Custom Location" appears, check BodyMap.tsx integration
- **Anatomical Names:** Front view automatically swaps left/right for medical accuracy

## Pain Map Hotspot System

### Statistics
- **Total Hotspots:** 523 anatomical regions
- **Front View:** 134 hotspots
- **Back View:** 389 hotspots
- **Validation Status:** ✅ 100% valid coordinates

### Key Files
- **Hotspot Definitions:** `client/src/components/steps/PainMappingStep.tsx` - Contains all 523 hotspot definitions
- **Active Component:** `client/src/components/ui/BodyMap.tsx` - Uses hotspot detection for pain point creation
- **Validation Utility:** `client/src/utils/validateHotspots.ts` - Comprehensive validation system
- **Documentation:** `PAIN_MAP_DOCUMENTATION.md` - Complete technical reference

### Click Detection Algorithm
1. User clicks on body diagram
2. Click coordinates captured and normalized (0-1 scale)
3. `findClosestHotspot()` searches all hotspots for current view
4. Euclidean distance calculation finds closest hotspot center
5. `correctAnatomicalLabel()` swaps left/right for front view
6. Pain point created with detected anatomical region name
7. Pain point displays region name in editor modal

### Coordinate System
- **Format:** Normalized coordinates (0.0 to 1.0 scale)
- **Origin:** Top-left corner of body diagram image
- **x:** Horizontal position (0.0 = left edge, 1.0 = right edge)
- **y:** Vertical position (0.0 = top edge, 1.0 = bottom edge)

### Anatomical Coverage Examples
- **Head & Neck:** Forehead, temples, cervical spine (C2-C7), occiput
- **Upper Extremities:** Shoulder, deltoid, biceps, forearm, wrist, hand, individual fingers
- **Trunk Front:** Pectorals, sternum, ribs, abdomen quadrants
- **Trunk Back:** Trapezius, scapulae, thoracic spine (T1-T12), lumbar spine (L1-L5), sacrum
- **Lower Extremities:** Hip, gluteal region, thigh, knee, lower leg, ankle, foot, toes

## Security Considerations

- Dashboard protected by `DASHBOARD_PASSWORD` environment variable
- Session-based file isolation prevents cross-user access
- File sanitization in upload handlers prevents directory traversal
- CORS configured for cross-origin requests in development
